# PrintShop 架构概览

> 版本: v1.0
> 更新: 2026-02-06

## 一、系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        企业微信 / 客户端                          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         AI Agent 层                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ 店长助理  │ │  设计师   │ │ 工艺专家  │ │供应商代理 │           │
│  │  (小印)  │ │  (小艺)  │ │  (老张)  │ │  (老李)  │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│       │            │            │            │                  │
│       └────────────┴────────────┴────────────┘                  │
│                          │                                       │
│                    ┌─────┴─────┐                                │
│                    │  路由调度  │                                │
│                    └───────────┘                                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         业务逻辑层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   报价引擎    │  │  聊天摘录    │  │  语义搜索    │          │
│  │ pricing-engine│  │ chat-extract │  │  pgvector   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据存储层                               │
│                                                                  │
│  ┌─────────────────────────┐  ┌─────────────────────────┐      │
│  │     云端知识库 (cloud)    │  │    租户知识库 (tenant)   │      │
│  │  ─────────────────────  │  │  ─────────────────────  │      │
│  │  • materials (材料)      │  │  • tenants (租户)       │      │
│  │  • crafts (工艺)         │  │  • stores (门店)        │      │
│  │  • product_templates    │  │  • suppliers (供应商)   │      │
│  │  • gifts (礼品)          │  │  • products (产品价格)  │      │
│  │  • gift_seasons (季节)   │  │  • gift_inventory      │      │
│  │  • industry_knowledge   │  │  • chat_extracts       │      │
│  │                         │  │                         │      │
│  │  【总部维护，只读】        │  │  【门店维护，读写】       │      │
│  └─────────────────────────┘  └─────────────────────────┘      │
│                                                                  │
│                      PostgreSQL + pgvector                       │
└─────────────────────────────────────────────────────────────────┘
```

## 二、多租户架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          总部 (我们)                             │
│                    管理云端知识库 + 系统运维                       │
└─────────────────────────────────────────────────────────────────┘
                                │
            ┌───────────────────┼───────────────────┐
            ▼                   ▼                   ▼
    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
    │   租户 A      │    │   租户 B      │    │   租户 C      │
    │  (连锁品牌)   │    │  (独立门店)   │    │  (其他品牌)   │
    │              │    │              │    │              │
    │  ┌────────┐  │    │  ┌────────┐  │    │  ┌────────┐  │
    │  │ 门店1  │  │    │  │ 门店   │  │    │  │ 门店1  │  │
    │  ├────────┤  │    │  └────────┘  │    │  ├────────┤  │
    │  │ 门店2  │  │    │              │    │  │ 门店2  │  │
    │  ├────────┤  │    │              │    │  └────────┘  │
    │  │ 门店3  │  │    │              │    │              │
    │  └────────┘  │    │              │    │              │
    └──────────────┘    └──────────────┘    └──────────────┘
    
    数据完全隔离：tenant_id + store_id + RLS
```

## 三、数据流

### 3.1 客户咨询流程

```
客户提问
    │
    ▼
┌─────────────┐
│ 店长助理接待 │ ← 查询 tenant.products (本地价格)
└─────────────┘
    │
    ├─ 简单问题 → 直接回答
    │
    ├─ 设计问题 → 转 设计师 ← 查询 cloud.product_templates
    │
    ├─ 材料问题 → 转 工艺专家 ← 查询 cloud.materials, cloud.crafts
    │
    └─ 大单外协 → 转 供应商代理 ← 查询 tenant.suppliers
```

### 3.2 知识录入流程

```
用户/供应商消息
    │
    ▼
┌─────────────────┐
│  聊天摘录解析    │ ← parse_supplier_text / parse_product_text
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ chat_extracts   │ ← 待确认状态
│   (暂存)        │
└─────────────────┘
    │
    ▼ 用户确认
┌─────────────────┐
│  目标表写入      │ → suppliers / products / gift_inventory
└─────────────────┘
```

### 3.3 报价流程

```
客户需求
    │
    ▼
┌─────────────────┐
│  识别产品类型    │ → card / print / booklet
└─────────────────┘
    │
    ▼
┌─────────────────┐
│  调用报价函数    │ → calc_card_price / calc_print_price / calc_booklet_price
└─────────────────┘
    │
    ├─ 查询 tenant.material_prices (材质价格)
    ├─ 查询 tenant.quantity_tiers (数量阶梯)
    └─ 查询 tenant.craft_prices (工艺价格)
    │
    ▼
┌─────────────────┐
│  返回报价明细    │ → 总价 + 单价 + 分项明细
└─────────────────┘
```

## 四、技术栈

| 层级 | 技术 |
|------|------|
| 客户端 | 企业微信 |
| AI Agent | OpenClaw + Claude/GPT |
| 数据库 | PostgreSQL 15+ |
| 向量搜索 | pgvector |
| 多租户 | RLS (Row Level Security) |

## 五、文件结构

```
projects/printshop/
├── README.md                    # 项目说明
├── agents/                      # AI Agent 定义
│   ├── store-assistant-agent.md # 店长助理
│   ├── designer-agent.md        # 设计师
│   ├── craft-expert-agent.md    # 工艺专家
│   └── supplier-agent.md        # 供应商代理
├── docs/                        # 文档
│   ├── architecture-overview.md # 架构概览（本文件）
│   ├── database-schema.md       # 数据库设计
│   ├── pricing-logic.md         # 报价逻辑
│   └── chat-extract-guide.md    # 聊天摘录指南
└── scripts/                     # SQL 脚本
    ├── init-db.sql              # 数据库初始化
    ├── pricing-engine.sql       # 报价引擎
    └── chat-extract.sql         # 聊天摘录解析
```

## 六、部署清单

### 6.1 数据库初始化顺序

```bash
1. psql -f init-db.sql           # 创建表结构
2. psql -f pricing-engine.sql    # 报价函数
3. psql -f chat-extract.sql      # 摘录解析
```

### 6.2 环境要求

- PostgreSQL 15+
- pgvector 扩展
- OpenAI API (embedding)
